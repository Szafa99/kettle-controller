<!DOCTYPE html>
<meta charset="utf-8" />
<head><meta name="viewport" content="width=device-width, initial-scale=1">
<title>WebSocket Test</title>

<script language="javascript" type="text/javascript">

var url = "ws://192.168.4.1:1337/";
var output;
var setTemp;
var websocket;
// 


// Call this to connect to the WebSocket server
function wsConnect(url) {
    console.log("connecting");
    // Connect to WebSocket server
    websocket = new WebSocket("ws://192.168.4.1:1337/");
    
    // Assign callbacks
    websocket.onopen = function(evt) { onOpen(evt) };
    websocket.onclose = function(evt) { onClose(evt) };
    websocket.onmessage = function(evt) { onMessage(evt) };
    websocket.onerror = function(evt) { onError(evt) };

            

}

// Called when a WebSocket connection is established with the server
function onOpen(evt) {

    // Log connection state
    console.log("Connected");
    // Get the current temperature
    
 
}

// Called when the WebSocket connection is closed
function onClose(evt) {

    // Log disconnection state
    console.log("Disconnected");
    setTimeout(function() { wsConnect(url) }, 2000);
}

// Called when a message is received from the server
function onMessage(evt) {

    // Print out our received message
    console.log("Received: " + evt.data);
   if(evt.data.includes("aimedTemp"))    
        document.getElementById("aimedTemp").innerText = evt.data.substr("aimedTemp".length,evt.data.length) + " ℃";
   else if(evt.data.includes("ds18b20Temp")){    
        document.getElementById("ds18b20Temp").innerText = evt.data.substr("ds18b20Temp".length,evt.data.length) + " ℃";
        setTimeout( ()=>{
                if(websocket.readyState == WebSocket.OPEN)
                    doSend("getTemp");
                },10000);
        }
    else if(evt.data.includes("engineState")){
        const state = evt.data.substr("engineState".length,evt.data.length);
        
        if(state==1){
            document.getElementById("engineState").style.backgroundColor="red";
            document.getElementById("engineState").innerText="Wyłącz kocioł";
            document.getElementById("engineState").value=0;
        }else if(state==0){
            document.getElementById("engineState").style.backgroundColor="green";
            document.getElementById("engineState").innerText="Włącz kocioł";
            document.getElementById("engineState").value=1;
        }
    }    

}

// Called when a WebSocket error occurs
function onError(evt) {
    console.log("ERROR: " + evt.data);
}

// Sends a message to the server (and prints it to the console)
function doSend(message) {
    console.log("Sending: " + message);
    websocket.send(message);
}

// Called whenever the HTML button is pressed
function onPress() {
    const newTemp=document.getElementById("newTemp").value;
    doSend(newTemp+"setTemp");
    doSend("getTemp");
    doSend("getAimedTemp");
}

function toggleEngine(){
    const state = document.getElementById("engineState").value;
    doSend(state+"setEngineState");
}

// Call the init function as soon as the page loads
window.onload=wsConnect;


</script>

<html style='text-align: center;align-items: center;background-color: darkslategrey;color: antiquewhite;'>
        

<div id="rootDiv" style="width: 50%; margin:0 auto;text-align: center;" >
        <div class="mydiv">
            <div class="left" >
                <h1>Temperatura w zbiorniku</h1><br/>
                <h1 id="ds18b20Temp" >0 ℃</h1> 
            </div>
            <div class="right">
                <h1>Ustawiona temperatura</h1>
                <h1 id="aimedTemp">0 ℃</h1>
                <input type="number" min="0" max="100" id="newTemp"/>
                <span class="validity"></span>
                <div style="width: 50%;margin: 0 auto;">
                    <button onclick="onPress()">Zmień</button> 
                </div> 
            </div>
        </div>
<div style="margin-top: 5%;"></div>
        <div class="mydiv">
            <div class="left" >
                <h1>Czas pracy</h1>
                <h1 id="heaterTime">min</h1>              
                <input type="time" min="0:0:0" max="01:30:00" step="1" id="newHeaterTime" type="text" /> 
                <span class="validity"></span>
                <div style="width: 50%;margin: 0 auto;">
                <button onclick="onPress()">Zmień</button> 
                </div>             
            </div>
            <div class="right" >
                <h1>Pozostały czas</h1>
                <h1 id="heaterTime">min</h1>             
            </div>
        </div>
<div style="margin-top: 5%;"></div>
        <div class="mydiv">
            <div class="left">
                 <h1>Wlacz mieszadlo co:</h1>               
                 <h2>min</h2>
                 <input type="time" min="0:0:0" max="01:30:00" step="1" id="newTemp" type="text" /> 
                 <span class="validity"></span>
                <div style="width: 50%;margin: 0 auto;">
                     <button onclick="onPress()">Zmień</button>
                     </div>
             </div>
             <div class="right">
                     <h1>Wlacz mieszadlo na</h1>
                     <h2> min</h2>
                     <input type="time" min="0:0:0" max="01:30:00" step="1" id="newTemp" type="text" /> 
                     <span class="validity"></span>
                     <div style="width: 50%;margin: 0 auto;">
                     <button onclick="onPress()">Zmień</button> 
                     </div>             
             </div>
         </div>

        <h1><button   id="engineState" style="background-color: green;" onclick="toggleEngine()" value="1">Włącz kocioł</button></h1>

    

        <style>
            input:invalid+span::after {
          position: absolute;
          content: '✖';
          padding-left: 5px;
        }
        
        input:valid+span::after {
          position: absolute;
          content: '✓';
          padding-left: 5px;
        }
            button {
          background-color: #04AA6D;
          border: none;
          color: white;
          padding: 20px;
          text-align: center;
          text-decoration: none;
          display: inline-block;
          font-size: 16px;
          margin: 20px 2px;
          border-radius: 33%;
        }
        
        .mydiv{
            border: white;
            border-width: thin;
            border-style: solid;
            display: inline-block;
            padding: 20px;
            width: 90%;
        }
        
        .right {
          float: right;
          padding: 10px;
          width: 40%;
        }
        .left {
          float: left;
          padding: 10px;
          width: 40%;
        }
        </style>
</html>